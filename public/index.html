<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <meta name="description" content="Retrieve meta information of city labels, transit stations, etc.">
    <title>Home</title>


    <!-- <link rel="stylesheet" href="static/css/map-js-ui.css"/> -->

    <!-- <link rel="stylesheet" href="static/css/main.css"/>
        <link rel="stylesheet" href="../static/css/bootstrap.min.css"/>

        <script src="../static/js/angular.js"></script>
        <script src="../static/js/jquery-3.3.1.min.js"></script>
        <script src="../static/js/popper.min.js"></script>
        <script src="../static/js/bootstrap.min.js"></script>
        <script src="../static/js/angular-route.js"></script>
        <script src="../static/js/angular-fire.js"></script>
        <script src="../static/js/firebase.js"></script>

        
        <script src="../static/js/mapsjs-core.js"></script>
        <script src="../static/js/mapsjs-service.js"></script>
        <script src="../static/js/mapsjs-ui.js"></script>
        <script src="../static/js/mapsjs-mapevents.js"></script> -->


    <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.0/mapsjs-ui.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.2.0/jszip.js"></script>


    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.0/mapsjs-ui.css?dp-version=1549984893" />


    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.8/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.8/angular-route.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.6.6/firebase.js"></script>
    <script src="https://cdn.firebase.com/libs/angularfire/2.3.0/angularfire.min.js"></script>

    <script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-core.js" charset="utf-8"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-service.js" charset="utf-8"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-ui.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-mapevents.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-clustering.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBcm7sxXzUzWFuc6OXLl3mmcOvZqq3mFHo",
            authDomain: "language-settings-b708e.firebaseapp.com",
            databaseURL: "https://language-settings-b708e.firebaseio.com",
            projectId: "language-settings-b708e",
            storageBucket: "language-settings-b708e.appspot.com",
            messagingSenderId: "255372102876",
            appId: "1:255372102876:web:e907ab7188f7d08f"
        };
        firebase.initializeApp(firebaseConfig);

        function loadMap($scope) {

            const app_id = "EC9XVOgMvc6wB4ycQRFH";
            const app_code = "vJKm39sNoH382UhujmuJ_g";

            var platform = new H.service.Platform({
                app_id: app_id,
                app_code: app_code,
                useCIT: true,
                useHTTPS: true
            });
            var defaultLayers = platform.createDefaultLayers();
            var map = new H.Map(document.getElementById('map'), defaultLayers.normal.map, {
                zoom: 13,
                center: {
                    lat: 13.043563,
                    lng: 77.626046
                }
            });
            //var ui = H.ui.UI.createDefault(map, defaultLayers);
            //var mapSettings = ui.getControl('mapsettings');
            //mapSettings.setEnabled(true);

            var currentPosition = new H.map.Marker({
                lat: 37.21,
                lng: -121.21
            });

            // map.addEventListener('tap', function(evt) {
            //     var coord = map.screenToGeo(evt.currentPointer.viewportX,
            //         evt.currentPointer.viewportY);
            //     let latVal = Math.abs(coord.lat.toFixed(4));
            //     let lngVal = Math.abs(coord.lng.toFixed(4));
            //     let posMarker = new H.map.Marker({
            //         lat: latVal,
            //         lng: lngVal
            //     });
            //     map.addObject(posMarker);
            //     alert(latVal + ',' + lngVal);
            // });

            // let arr = [
            //     [13.0481, 77.6284],
            //     [13.1049, 77.6723],
            //     [13.0897, 77.6884],
            //     [13.1216, 77.6754],
            //     [13.0922, 77.6654],
            //     [13.0775, 77.5758],
            //     [13.0684, 77.5506]
            // ];



            // for (let k in arr) {
            //     let lat = k[0];
            //     let lng = k[1];

            // }

            //map.addObject(currentPosition);

            return map;
        }

        function findMatrixDistance(start, coords) {
            var prom = new Promise(function(resolve, reject) {
                const app_id = "EC9XVOgMvc6wB4ycQRFH";
                const app_code = "vJKm39sNoH382UhujmuJ_g";
                const url = "https://matrix.route.api.here.com/routing/7.2/calculatematrix.json?app_id=" + app_id + "&app_code=" + app_code + "&start0=" + start + coords + "&mode=fastest;car;traffic:disabled&summaryAttributes=tt,di"
                fetch(url, {
                    method: "GET"
                }).then(function(response) {
                    return response.json();
                }).then(function(responseJSON) {
                    console.log(JSON.stringify(responseJSON))
                    var travelTime = responseJSON["response"].matrixEntry;
                    resolve(travelTime);
                }).catch(function(err) {
                    reject(Error(err));
                });
            });
            return prom;
        }

        function distBetweenTwoPoints() {
            const url = "https://route.api.here.com/routing/7.2/calculateroute.json?app_id=" + app_id + "&app_code=" + app_code + "&waypoint0=geo!" + way1 + "&waypoint1=geo!" + way2 + "&routeattributes=wp,sm,sh,sc&mode=fastest;car;traffic:enabled";
            console.log(url);
            fetch(url, {
                method: "GET"
            }).then(function(response) {
                return response.json();
            }).then(function(responseJSON) {
                var travelTime = responseJSON["response"].route[0].summary.travelTime;

            }).catch(function(err) {
                console.log(err);
            });
        }

        function polygonToWKT(polygon) {
            const geometry = polygon.getGeometry();
            return geometry.toString();
        }

        function uploadGeofence(layerId, name, geometry, app_id, app_code) {
            const zip = new JSZip();
            zip.file("data.wkt", "NAME\tWKT\n" + name + "\t" + geometry);
            return zip.generateAsync({
                type: "blob"
            }).then(content => {
                var formData = new FormData();
                formData.append("zipfile", content);
                return fetch("https://gfe.api.here.com/2/layers/upload.json", {
                    headers: {
                        "content-type": "multipart/form-data"
                    },
                    params: {
                        "app_id": app_id,
                        "app_code": app_code,
                        "layer_id": layerId
                    },
                    data: formData,
                    method: "POST"
                }).then(function(response) {
                    console.log("response:" + JSON.stringify(response));
                }).catch(function(err) {
                    console.log("err:" + JSON.stringify(err));
                });
            });
        }

        function fenceRequest(layerIds, position, platform) {
            return new Promise((resolve, reject) => {
                platform.getGeofencingService().request(
                    H.service.extension.geofencing.Service.EntryPoint.SEARCH_PROXIMITY, {
                        'layer_ids': layerIds,
                        'proximity': position.lat + "," + position.lng,
                        'key_attributes': ['NAME']
                    },
                    result => {
                        resolve(result);
                    }, error => {
                        reject(error);
                    }
                );
            });
        }

        function getCurrentLocation() {
            navigator.geolocation.getCurrentPosition(function(position) {
                console.log(position);
            });
        }

        function geocode(platform, text) {
            var geocoder = platform.getGeocodingService(),
                geocodingParameters = {
                    searchText: text,
                    jsonattributes: 1
                };

            geocoder.geocode(
                geocodingParameters,
                onSuccess,
                onError
            );
        }

        function onSuccess(result) {
            var locations = result.response.view[0].result;
            addLocationsToMap(locations);

        }

        function onError(error) {
            console.log(JSON.stringify(error));
            alert('Ooops!');
        }


        function addLocationsToMap(locations) {
            var group = new H.map.Group(),
                position,
                i;

            // Add a marker for each location found
            for (i = 0; i < locations.length; i += 1) {
                position = {
                    lat: locations[i].location.displayPosition.latitude,
                    lng: locations[i].location.displayPosition.longitude
                };
                marker = new H.map.Marker(position);
                marker.label = locations[i].location.address.label;
                group.addObject(marker);
            }

            group.addEventListener('tap', function(evt) {
                map.setCenter(evt.target.getPosition());
                openBubble(evt.target.getPosition(), evt.target.label);
            }, false);

            // Add the locations group to the map
            map.addObject(group);
            map.setCenter(group.getBounds().getCenter());
        }

        function switchMapLanguage(map, platform, language) {
            var mapTileService = platform.getMapTileService({
                type: 'base'
            });
            var langMapLayer = mapTileService.createTileLayer(
                'maptile',
                'normal.day',
                256,
                'png8', {
                    lg: 'CHI'
                }
            );
            map.setBaseLayer(langMayLayer);

            var ui = H.ui.UI.createDefault(map, defaultLayers, 'zh-CN');
            ui.removeControl('mapsettings');
        }


        function getClusterMap() {
            function addMarkersToMap(map) {
                var parisMarker = new H.map.Marker({
                    lat: 48.8567,
                    lng: 2.3508
                });
                map.addObject(parisMarker);

                var romeMarker = new H.map.Marker({
                    lat: 41.9,
                    lng: 12.5
                });
                map.addObject(romeMarker);

                var berlinMarker = new H.map.Marker({
                    lat: 52.5166,
                    lng: 13.3833
                });
                map.addObject(berlinMarker);

                var madridMarker = new H.map.Marker({
                    lat: 40.4,
                    lng: -3.6833
                });
                map.addObject(madridMarker);

                var londonMarker = new H.map.Marker({
                    lat: 51.5008,
                    lng: -0.1224
                });
                map.addObject(londonMarker);
            }
            const app_id = "EC9XVOgMvc6wB4ycQRFH";
            const app_code = "vJKm39sNoH382UhujmuJ_g";
            var platform = new H.service.Platform({
                app_id: app_id,
                app_code: app_code,
                useCIT: true,
                useHTTPS: true
            });
            var defaultLayers = platform.createDefaultLayers();

            var map = new H.Map(document.getElementById('maps'), defaultLayers.normal.map, {
                zoom: 4,
                center: {
                    lat: 13.043563,
                    lng: 77.626046
                }
            });
            var behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
            //var ui = H.ui.UI.createDefault(map, defaultLayers);
            //addMarkersToMap(map);
        }


        function loadClusteringMap(data) {
            function startClustering(map, data) {
                var dataPoints = data.map(function(item) {
                    return new H.clustering.DataPoint(item.latitude, item.longitude);
                });
                var clusteredDataProvider = new H.clustering.Provider(dataPoints, {
                    clusteringOptions: {
                        eps: 32,
                        minWeight: 2
                    }
                });

                var clusteringLayer = new H.map.layer.ObjectLayer(clusteredDataProvider);

                map.addLayer(clusteringLayer);
            }
            const app_id = "EC9XVOgMvc6wB4ycQRFH";
            const app_code = "vJKm39sNoH382UhujmuJ_g";

            var platform = new H.service.Platform({
                app_id: app_id,
                app_code: app_code,
                useHTTPS: true,
                useCIT: true
            });
            var defaultLayers = platform.createDefaultLayers();

            var map = new H.Map(document.getElementById('markermap'), defaultLayers.normal.map, {
                center: new H.geo.Point(30.789, 33.790),
                zoom: 2
            });

            var behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));


            var ui = H.ui.UI.createDefault(map, defaultLayers);

            startClustering(map, data);
        }
    </script>

    <script>
        function getLocation() {
            var locationPromise = new Promise(function(resolve, reject) {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function showPosition(position) {
                        resolve(position);
                    });
                } else {
                    reject(Error("Geolocation is not supported by this browser."));
                }
            });

            return locationPromise;
        }
    </script>

    <script>
        var app = angular.module("App", ['ngRoute', "firebase"]);

        app.run(function($rootScope) {
            $rootScope.$on("$locationChangeStart", function(event, next, current) {
                var u = next.indexOf("#/");
                var data = next.substr(u + 2);
                var elements = $('.nav-item');
                elements.each(function(index, element) {
                    var mapLi = $(element);
                    var mapA = $(mapLi).children('a');
                    $(mapLi).removeClass('bg-primary');
                    $(mapA).removeClass('text-white');
                    $(mapA).addClass('text-secondary');
                });
                switch (data) {
                    case "Map":
                        var mapLi = $('.nav-item')[3];
                        var mapA = $(mapLi).children('a');
                        $(mapA).removeClass('text-secondary');
                        $(mapA).addClass('text-white');
                        $(mapLi).addClass('bg-primary');


                        break;
                    case "Dashboard":
                        var mapLi = $('.nav-item')[0];
                        var mapA = $(mapLi).children('a');
                        $(mapA).removeClass('text-secondary');
                        $(mapA).addClass('text-white');
                        $(mapLi).addClass('bg-primary');

                        break;
                    case "CreateItems":
                        var mapLi = $('.nav-item')[1];
                        var mapA = $(mapLi).children('a');
                        $(mapA).removeClass('text-secondary');
                        $(mapA).addClass('text-white');
                        $(mapLi).addClass('bg-primary');


                        break;
                    case "ViewDrivers":
                        var mapLi = $('.nav-item')[2];
                        var mapA = $(mapLi).children('a');
                        $(mapA).removeClass('text-secondary');
                        $(mapA).addClass('text-white');
                        $(mapLi).addClass('bg-primary');


                        break;

                    case "Feedback":
                        var mapLi = $('.nav-item')[4];
                        var mapA = $(mapLi).children('a');
                        $(mapA).removeClass('text-secondary');
                        $(mapA).addClass('text-white');
                        $(mapLi).addClass('bg-primary');


                        break;
                    case "Returns":
                        var mapLi = $('.nav-item')[5];
                        var mapA = $(mapLi).children('a');
                        $(mapA).removeClass('text-secondary');
                        $(mapA).addClass('text-white');
                        $(mapLi).addClass('bg-primary');


                        break;
                    default:
                        break;
                }


            });
        });

        app.controller("test", function($scope) {
            var itemsRef = firebase.database().ref("/admin/xxx/profile");
            itemsRef.once('value', function(data) {
                var obj = data.val();
                $scope.profile = obj;
                $scope.$applyAsync();
            });
        });

        app.config(['$locationProvider', function($locationProvider) {
            $locationProvider.hashPrefix('');
        }]);

        app.config(['$routeProvider', function($routeProvider) {
            $routeProvider
                .when('/Dashboard', {
                    templateUrl: 'Dashboard.html',
                    controller: 'DashboardController'
                })
                .when('/CreateItems', {
                    templateUrl: 'OrderDistribution.html',
                    controller: 'CreateItemsController'
                })
                .when('/ViewDrivers', {
                    templateUrl: 'ViewDrivers.html',
                    controller: 'ViewDriversController'
                })
                .when('/Map', {
                    templateUrl: 'Map.html',
                    controller: 'MapController'
                })
                .when('/Feedback', {
                    templateUrl: 'Feedbacks.html',
                    controller: 'FeedbacksController'
                })
                .when('/FeedbackAnalytics', {
                    templateUrl: 'FeedbackAnalytics.html',
                    controller: 'FeedbackAnalyticsController'
                })
                .when('/MapOrderView', {
                    templateUrl: 'MarkerClustering.html',
                    controller: 'MarkerClusteringController'
                })
                .when('/Returns', {
                    templateUrl: 'ReturnItems.html',
                    controller: 'ReturnsController'
                })
                .otherwise({
                    redirectTo: '/Dashboard'
                })
        }]);

        app.controller('CreateItemsController', function($scope) {
            var itemsRef = firebase.database().ref("/deliveries/ToBeDelivered/15-05-2019/");


            $scope.checkedValues = [];
            $scope.driverVisible = true;
            $scope.clusterList = [];
            $scope.getClusterMap = getClusterMap();
            $scope.geoData = [];
            $scope.noitems = true;
            $scope.fetchClusters = false;
            $scope.itemsData = {};
            $scope.clusteredData = [];


            $scope.visibleChange = function() {
                if ($scope.driverVisible) {
                    return "visible";
                } else {
                    return "invisible";
                }
            };

            $scope.populateMap = function() {
                window.location.href = "#MapOrderView";
            };



            $scope.selectDriver = function() {
                var driver = $scope.driver;
                for (let x in $scope.tempClusterData) {
                    let selectedItem = $scope.tempClusterData[x];
                    firebase.database().ref("/users/").child(selectedItem.userId).child("orders").child(selectedItem.orderId).child("published").set(true);
                    firebase.database().ref("/users/").child(selectedItem.userId).child("orders").child(selectedItem.orderId).child("driverName").set(driver.Name);
                    firebase.database().ref("/users/").child(selectedItem.userId).child("orders").child(selectedItem.orderId).child("driverMobile").set(driver.Mobile);
                    firebase.database().ref("/users/").child(selectedItem.userId).child("orders").child(selectedItem.orderId).child("driverId").set(driver.driverId);

                    firebase.database().ref("/deliveries/ToBeDelivered/15-05-2019").child(selectedItem.orderId).child("published").set(true);
                    firebase.database().ref("/deliveries/ToBeDelivered/15-05-2019").child(selectedItem.orderId).child("driverId").set(driver.driverId);
                    //firebase.database().ref("/drivers/" + driver.driverId + "/currentOrder/" + selectedItem.orderId + "/").set(selectedItem);
                }
            };

            // $scope.check = function(i, data) {
            //     console.log(data);
            //     var checkBox = document.getElementById("checkbox" + i);
            //     if (checkBox.checked) {
            //         $scope.checkedValues.push(data);
            //     } else {
            //         $scope.checkedValues = $scope.checkedValues.filter(function(value, index, arr) {
            //             return value.orderId !== data.orderId;
            //         });
            //     }
            //     console.log($scope.checkedValues);
            // };

            $scope.searchDrivers = function(values) {

                $scope.tempClusterData = values;

                getLocation().then(function(response) {
                    var coords = response.coords;
                    var start = coords.latitude + "," + coords.longitude;
                    
                    var ref = firebase.database().ref("/drivers/");
                    ref.once('value')
                        .then(function(data) {
                            var i = 0;
                            let coordsValue = "";
                            let driversArr = [];
                            var driversList = data.val();
                            for (var driver in driversList) {
                                if (!driversList[driver].inRide && driversList[driver].isLive) {
                                    var location = driversList[driver].livelocation;
                                    var way2 = coords.latitude + "," + coords.longitude;
                                    coordsValue = coordsValue + "&destination" + i + "=" + way2;
                                    i = i + 1;
                                    driversArr.push(driversList[driver]);
                                }
                            }
                            console.log(start+coordsValue)
                            findMatrixDistance(start, coordsValue).then(function(response) {
                                let min = 999999999;
                                let iVal = 0;
                                for (var index = 0; index < response.length; index++) {
                                    var x = response[index].summary;
                                    if (x.travelTime < min) {
                                        min = x.travelTime;
                                        iVal = index;
                                    }
                                }
                                $scope.driver = driversArr[iVal];
                                $scope.driverVisible = false;
                                $scope.$apply();
                            }).catch(function(err) {
                                console.log(err);
                            });
                        }).catch(function(err) {
                            console.log(err);
                        });
                }).catch(function(err) {
                    console.log(err);
                });
            };

            $scope.getNoItemsVisibility = function() {
                if ($scope.noitems) {
                    return "visible";
                } else {
                    return "invisible";
                }
            }

            $scope.getFetchClusters = function() {
                if ($scope.fetchClusters) {
                    return "visible";
                } else {
                    return "invisible";
                }
            }

            $scope.getOrders = function() {

                if ($scope.geoData.length == 0) {
                    alert("No orders processed");
                    return;
                }

                let geoData = [];
                for (let ii in $scope.geoData) {
                    let latlngstr = $scope.geoData[ii].split(',');
                    let ddt = [];
                    ddt.push(parseFloat(latlngstr[0].trim()));
                    ddt.push(parseFloat(latlngstr[1].trim()));
                    geoData.push(ddt);
                }
                fetch('http://localhost:5000/clusterData', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(geoData)
                }).then(function(response) {
                    return response.json();
                }).then(function(res) {
                    let data = JSON.parse(res.data);
                    for (let index in data) {
                        let coords = data[index];
                        let dataCluster = [];
                        for (let j in coords) {
                            let locString = coords[j][0] + "," + coords[j][1];
                            dataCluster.push($scope.itemsData[locString]);
                        }
                        $scope.clusteredData.push(dataCluster);
                    }
                    console.log($scope.clusteredData);
                    $scope.$apply();
                }).catch(function(err) {
                    console.log(err);
                });
            };



            itemsRef.on('value', function(data) {
                var obj = data.val();
                for (let j in obj) {
                    $scope.itemsData[obj[j].location] = obj[j];
                }
                $scope.geoData = Object.keys($scope.itemsData);
                console.log($scope.geoData);
                $scope.noitems = false;
                $scope.fetchClusters = true;
                $scope.$applyAsync();
            });

            itemsRef.on('child_removed', function(data) {
                // for (var i = 0; i < arr.length; i++) {
                //     if (arr[i] === 5) {
                //         arr.splice(i, 1);
                //     }
                // }
                console.log("Removed:" + JSON.stringify(data));
            });

        });

        app.controller('DashboardController', function($scope) {

            var ref = firebase.database().ref("/admin/xxx/statisticalinfo/");
            ref.once('value', function(data) {
                var obj = data.val();
                setValues($scope, obj);
                $scope.$applyAsync();
            });

            var liveRef = firebase.database().ref("/deliveries/live/15-05-2019/");

            $scope.liveDeliveryData = [];

            liveRef.once('value', function(data) {
                var obj = data.val();
                for (let x in obj) {
                    $scope.liveDeliveryData.push(obj[x]);
                }
                $scope.$applyAsync();
            });
        });

        function setValues($scope, obj) {
            $scope.numberofdeliveriesdone = obj.numberofdeliveriesdone;
            $scope.numberofdeliveriesdonetoday = obj.numberofdeliveriesdonetoday;
            $scope.numberofdeliveriestoday = obj.numberofdeliveriestoday;
            $scope.numberofdrivers = obj.numofdrivers;
        }

        app.controller('ViewDriversController', function($scope) {
            var driversRef = firebase.database().ref("/drivers/");

            $scope.driverData = [];

            driversRef.once('value', function(data) {
                var obj = data.val();
                for (let val in obj) {
                    $scope.driverData.push(obj[val]);
                }
                //console.log(JSON.stringify(obj));
                // $scope.driverData.push(obj);
                $scope.$applyAsync();
            });
        });

        app.controller('MapController', function($scope) {
            let map = loadMap($scope);
            var behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));

            var ref = firebase.database().ref("/drivers/");
            var group = new H.map.Group();
            $scope.map = map;
            var markers = [];
            ref.on('value', function(data) {
                var datas = Object.values(data.val());
                for (const driverData of datas) {
                    var id = driverData["driverId"];
                    var location = driverData["livelocation"];
                    var lat = location["latitude"];
                    var long = location["longitude"];
                    var x = new H.map.Marker({
                        lat: lat,
                        lng: long
                    });
                    if (id in $scope.datamap) {
                        $scope.datamap[id].marker.setPosition({
                            lat: lat,
                            lng: long
                        });
                    } else {
                        $scope.datamap[id] = {};
                        $scope.datamap[id].name = driverData["Name"];
                        $scope.datamap[id].marker = x;
                        markers.push(x);
                        group.addObjects(markers);
                        if (group in map.getObjects())
                            map.removeObject(group);
                        map.addObject(group);
                        map.setViewBounds(group.getBounds());
                    }
                }
                $scope.$applyAsync();
            });

            $scope.driverValue = "Select Driver";

            $scope.getSelectedDriver = function(driver) {
                console.log(driver);
                console.log("datamap:" + driver);
            };
        });

        app.controller('FeedbacksController', function($scope) {
            var feedbackRef = firebase.database().ref("/feedbacks/");
            $scope.redirectToAnalytics = function() {
                var urlData = "";
                for (var n in $scope.feedbackData) {
                    urlData += $scope.feedbackData[n].comment + ".";
                }
                fetch("/tone?text=" + urlData, {
                    method: 'GET',
                    headers: {
                        "Accept-Cross-Origin-Headers": "*"
                    }
                }).then(function(data) {
                    return data.json();
                }).then(function(resp) {
                    console.log(JSON.stringify(resp));
                    resp.pos = (resp.pos * 100).toPrecision(2) + "%";
                    resp.neg = (resp.neg * 100).toPrecision(2) + "%";
                    resp.neu = (resp.neu * 100).toPrecision(2) + "%";
                    $scope.sentimentValues = resp;
                    $scope.$apply();
                }).catch(function(err) {
                    console.log(err);
                });
            };
            $scope.feedbackData = [];
            feedbackRef.once('value', function(data) {
                var obj = data.val();
                for (let x in obj) {
                    $scope.feedbackData.push(obj[x]);
                }

                $scope.$applyAsync();
            });
        });

        app.controller('ReturnsController', function($scope) {

            var returnsRef = firebase.database().ref("/orders/returns/");

            $scope.itemsData = [];

            $scope.searchDrivers = function(value){
                    var start = value.location;
                    var latlngs = value.location.split(",");
                    var coords = {};
                    coords["latitude"] = latlngs[0];
                    coords["longitude"] = latlngs[1];
                    var ref = firebase.database().ref("/drivers/");
                    ref.once('value')
                        .then(function(data) {
                            var i = 0;
                            let coordsValue = "";
                            let driversArr = [];
                            var driversList = data.val();
                            for (var driver in driversList) {
                                if (!driversList[driver].inRide && driversList[driver].isLive) {
                                    var location = driversList[driver].livelocation;
                                    var way2 = coords.latitude + "," + coords.longitude;
                                    coordsValue = coordsValue + "&destination" + i + "=" + way2;
                                    i = i + 1;
                                    driversArr.push(driversList[driver]);
                                }
                            }
                            findMatrixDistance(start, coordsValue).then(function(response) {
                                let min = 999999999;
                                let iVal = 0;
                                for (var index = 0; index < response.length; index++) {
                                    var x = response[index].summary;
                                    if (x.travelTime < min) {
                                        min = x.travelTime;
                                        iVal = index;
                                    }
                                }
                                console.log(JSON.stringify(driversArr[iVal]))
                                $scope.chosenDriver = driversArr[iVal];
                                $scope.$applyAsync();
                            }).catch(function(err) {
                                console.log(err);
                            });
                        }).catch(function(err) {
                            console.log(err);
                        });
            };

            returnsRef.once('value', function(data) {
                var obj = data.val();
                for (let val in obj) {
                    $scope.itemsData.push(obj[val]);
                }
                console.log(JSON.stringify(obj));
                $scope.$applyAsync();
            });
        });

        app.controller('MarkerClusteringController', function($scope, $http) {
            // $http.get('sample.json').then(function(data) {
            //     console.log(Object.keys(data));
            //     loadClusteringMap(data.data);
            // });
            $scope.clusterData = [];

            var itemsRef = firebase.database().ref("/deliveries/ToBeDelivered/15-05-2019/");
            itemsRef.on('value', function(data) {
                var obj = data.val();
                for (let j in obj) {
                    let latLng = obj[j].location.split(",");
                    let geo = {};
                    geo["latitude"] = latLng[0];
                    geo["longitude"] = latLng[1];
                    $scope.clusterData.push(geo);
                }
                loadClusteringMap($scope.clusterData);
                console.log($scope.clusterData);
                $scope.$applyAsync();
            });
        });
    </script>

    <script>
        //Code for side drawer
        $('document').ready(function() {
            var preLi = $('.nav-item')[0];
            var preA = $(preLi).children('a');
            $(preA).removeClass('text-secondary');
            $(preA).addClass('text-white');
            $('.nav-link').click(function(e) {

                $(preLi).removeClass('bg-primary');
                $(preA).removeClass('text-white');
                $(preA).addClass('text-secondary');

                preLi = $(e.target).parent("li");
                preA = e.target;

                $(preLi).addClass('bg-primary');
                $(e.target).removeClass('text-secondary');
                $(e.target).addClass('text-white');

            });

            $('.nav-item').click(function(e) {

                $(preLi).removeClass('bg-primary');
                $(preA).removeClass('text-white');
                $(preA).addClass('text-secondary');

                preA = $(e.target).children("a");
                preLi = e.target;

                $(preLi).addClass('bg-primary');
                $(preA).removeClass('text-secondary');
                $(preA).addClass('text-white');

            });

        });
    </script>



</head>

<body style='background-color:#2196f3;' ng-app="App" ng-controller="test" ng-Init="datamap={};checkedValues=[];sentimentValues={neg:0,compound:0,neu:0,pos:0};driver={name:'Loading....',mobile:'Please Wait'};profile={name:'xxxx',email:'xxx@gmail.com',mobile:'xxxxxxxxxx',area:'xxxxxxxxxxxxxxx'};itemsData=[];feedbackData=[];driverData=[];liveDeliveryData=[];numberofdeliveriestoday=0;numberofdeliveriesdonetoday=0;numberofdeliveriesdone=0;numberofdrivers=0;">
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-3">
                <div class="card m-1">
                    <div class="card-body">
                        <h5 class="card-title">Admin User</h5>
                        <hr>
                        <ul class="nav flex-column">
                            <li class="nav-item bg-primary">
                                <a class="nav-link text-secondary" href="#Dashboard">Dashboard</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-secondary" href="#CreateItems">Items</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-secondary" href="#ViewDrivers">View Drivers</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-secondary" href="#Map">Monitor Drivers</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-secondary" href="#Feedback">Feedbacks</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-secondary" href="#Returns">Returns</a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="card m-1">
                    <div class="card-body">
                        <h5 class="card-title">Profile</h5>
                        <hr>
                        <p>Name: {{ profile.name }}</p>
                        <p>Mobile: {{ profile.mobile }}</p>
                        <p>Email: {{ profile.email }}</p>
                        <p>Area: {{ profile.area }}</p>
                    </div>
                </div>
            </div>
            <div class="col-sm-9" ng-view>

            </div>
        </div>
    </div>
</body>

</html>